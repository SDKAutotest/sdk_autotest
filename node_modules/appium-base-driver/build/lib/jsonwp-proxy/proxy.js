'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _jsonwpStatusStatus = require('../jsonwp-status/status');

var _protocolErrors = require('../protocol/errors');

var log = _appiumSupport.logger.getLogger('JSONWP Proxy');
// TODO: Make this value configurable as a server side capability
var LOG_OBJ_LENGTH = 1024; // MAX LENGTH Logged to file / console
var DEFAULT_REQUEST_TIMEOUT = 240000;

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
  }

  // abstract the call behind a member function
  // so that we can mock it in tests

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      var currentRequest,
          args$2$0 = arguments;
      return _regeneratorRuntime.async(function request$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            currentRequest = _requestPromise2['default'].apply(undefined, args$2$0);

            this._activeRequests.push(currentRequest);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(currentRequest['finally'](function () {
              return _lodash2['default'].pull(_this._activeRequests, currentRequest);
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getActiveRequestsCount',
    value: function getActiveRequestsCount() {
      return this._activeRequests.length;
    }
  }, {
    key: 'cancelActiveRequests',
    value: function cancelActiveRequests() {
      try {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(this._activeRequests), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var r = _step.value;

            r.cancel();
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      } finally {
        this._activeRequests = [];
      }
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_lodash2['default'].includes(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') {
        url = '/';
      }
      var proxyBase = this.scheme + '://' + this.server + ':' + this.port + this.base;
      var endpointRe = '(/(session|status))';
      var remainingUrl = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        remainingUrl = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        remainingUrl = url;
      } else {
        throw new Error('Did not know what to do with url \'' + url + '\'');
      }

      var stripPrefixRe = new RegExp('^.+(/(session|status).*)$');
      if (stripPrefixRe.test(remainingUrl)) {
        remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
      }

      if (!new RegExp(endpointRe).test(remainingUrl)) {
        remainingUrl = '/session/' + this.sessionId + remainingUrl;
      }

      var requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(remainingUrl)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(remainingUrl);
        remainingUrl = remainingUrl.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Could not find :session section for url: ' + remainingUrl);
      }
      remainingUrl = remainingUrl.replace(/\/$/, ''); // can't have trailing slashes
      return proxyBase + remainingUrl;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
      var newUrl, reqOpts, bodyLog, res, resBody, responseError;
      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: newUrl,
              method: method,
              headers: {
                'content-type': 'application/json; charset=utf-8',
                'user-agent': 'appium',
                accept: '*/*'
              },
              resolveWithFullResponse: true,
              timeout: this.timeout,
              forever: true
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }

            // GET methods shouldn't have any body. Most servers are OK with this, but WebDriverAgent throws 400 errors
            if (method === 'GET') {
              reqOpts.json = null;
            }

            bodyLog = body ? 'with body: ' + _lodash2['default'].truncate(JSON.stringify(body), { length: LOG_OBJ_LENGTH }) : 'with no body';

            log.debug('Proxying [' + method + ' ' + (url || "/") + '] to [' + method + ' ' + newUrl + '] ' + bodyLog);

            res = undefined, resBody = undefined;
            context$2$0.prev = 8;
            context$2$0.next = 11;
            return _regeneratorRuntime.awrap(this.request(reqOpts));

          case 11:
            res = context$2$0.sent;

            resBody = res.body;
            log.debug('Got response with status ' + res.statusCode + ': ' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: LOG_OBJ_LENGTH }));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            context$2$0.next = 22;
            break;

          case 17:
            context$2$0.prev = 17;
            context$2$0.t0 = context$2$0['catch'](8);
            responseError = undefined;

            try {
              responseError = JSON.parse(context$2$0.t0.error);
            } catch (e1) {
              if (_lodash2['default'].isString(context$2$0.t0.error) && context$2$0.t0.error.length) {
                log.warn('Got unexpected response: ' + _lodash2['default'].truncate(context$2$0.t0.error, { length: 300 }));
              }
              responseError = _lodash2['default'].isPlainObject(context$2$0.t0.error) ? context$2$0.t0.error : null;
            }
            throw new _protocolErrors.errors.ProxyRequestError('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message), responseError, context$2$0.t0.statusCode);

          case 22:
            return context$2$0.abrupt('return', [res, resBody]);

          case 23:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[8, 17]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var _ref, _ref2, response, resBody, _status, message;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 2:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 2);
            response = _ref2[0];
            resBody = _ref2[1];

            resBody = _appiumSupport.util.safeJsonParse(resBody);

            if (!_appiumSupport.util.hasValue(resBody.status)) {
              context$2$0.next = 17;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 10;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 10:
            _status = parseInt(resBody.status, 10);

            if (!(!isNaN(_status) && _status !== 0)) {
              context$2$0.next = 15;
              break;
            }

            message = resBody.value;

            if (_lodash2['default'].has(resBody.value, 'message')) {
              message = _lodash2['default'].isEmpty(message) ? resBody.value.message : message + ' ' + resBody.value.message;
            }
            throw (0, _protocolErrors.errorFromMJSONWPStatusCode)(_status, _lodash2['default'].isEmpty(message) ? (0, _jsonwpStatusStatus.getSummaryByCode)(_status) : message);

          case 15:
            context$2$0.next = 26;
            break;

          case 17:
            if (!_lodash2['default'].has(resBody, 'value')) {
              context$2$0.next = 24;
              break;
            }

            if (!(response.statusCode === 200)) {
              context$2$0.next = 20;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 20:
            if (!(_lodash2['default'].isPlainObject(resBody.value) && resBody.value.error)) {
              context$2$0.next = 22;
              break;
            }

            throw (0, _protocolErrors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message);

          case 22:
            context$2$0.next = 26;
            break;

          case 24:
            if (!(response.statusCode === 200)) {
              context$2$0.next = 26;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 26:
            throw new _protocolErrors.errors.UnknownError('Did not know what to do with response code \'' + response.statusCode + '\' ' + ('and response body \'' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: 300 }) + '\''));

          case 27:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getSessionIdFromUrl',
    value: function getSessionIdFromUrl(url) {
      var match = url.match(/\/session\/([^\/]+)/);
      return match ? match[1] : null;
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var _ref3, _ref32, response, body, reqSessionId;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.proxy(req.originalUrl, req.method, req.body));

          case 2:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            response = _ref32[0];
            body = _ref32[1];

            res.headers = response.headers;
            res.set('content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id from the request or from current session
            body = _appiumSupport.util.safeJsonParse(body);
            if (body && body.sessionId) {
              reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

              if (reqSessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + reqSessionId);
                body.sessionId = reqSessionId;
              } else if (this.sessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + this.sessionId);
                body.sessionId = this.sessionId;
              }
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];

// Got response in MJSONWP format

// Got response in W3C format

// Unknown protocol. Keeping it because of the backward compatibility
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozs2QkFDTyxnQkFBZ0I7OzhCQUN6QixpQkFBaUI7Ozs7a0NBQ0oseUJBQXlCOzs4QkFDZSxvQkFBb0I7O0FBRzdGLElBQU0sR0FBRyxHQUFHLHNCQUFPLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQzs7QUFFN0MsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQzVCLElBQU0sdUJBQXVCLEdBQUcsTUFBTSxDQUFDOztJQUVqQyxPQUFPO0FBQ0MsV0FEUixPQUFPLEdBQ2E7UUFBWCxJQUFJLHlEQUFHLEVBQUU7OzBCQURsQixPQUFPOztBQUVULG1CQUFjLElBQUksRUFBRTtBQUNsQixZQUFNLEVBQUUsTUFBTTtBQUNkLFlBQU0sRUFBRSxXQUFXO0FBQ25CLFVBQUksRUFBRSxJQUFJO0FBQ1YsVUFBSSxFQUFFLFNBQVM7QUFDZixlQUFTLEVBQUUsSUFBSTtBQUNmLGFBQU8sRUFBRSx1QkFBdUI7S0FDakMsRUFBRSxJQUFJLENBQUMsQ0FBQztBQUNULFFBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUN4QyxRQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQztHQUMzQjs7Ozs7ZUFaRyxPQUFPOztXQWdCRztVQUNOLGNBQWM7Ozs7Ozs7QUFBZCwwQkFBYyxHQUFHLHNEQUFnQjs7QUFDdkMsZ0JBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDOzs2Q0FDN0IsY0FBYyxXQUFRLENBQUM7cUJBQU0sb0JBQUUsSUFBSSxDQUFDLE1BQUssZUFBZSxFQUFFLGNBQWMsQ0FBQzthQUFBLENBQUM7Ozs7Ozs7Ozs7S0FDeEY7OztXQUVzQixrQ0FBRztBQUN4QixhQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDO0tBQ3BDOzs7V0FF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QUM7Ozs7O0FBQXpFLG9CQUFRO0FBQUUsZ0JBQUk7O0FBQ25CLGVBQUcsQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQztBQUMvQixlQUFHLENBQUMsR0FBRyxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Ozs7QUFJMUQsZ0JBQUksR0FBRyxvQkFBSyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDaEMsZ0JBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDcEIsMEJBQVksR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQzs7QUFDOUQsa0JBQUksWUFBWSxFQUFFO0FBQ2hCLG1CQUFHLENBQUMsSUFBSSwwQkFBd0IsSUFBSSxDQUFDLFNBQVMsY0FBUyxZQUFZLENBQUcsQ0FBQztBQUN2RSxvQkFBSSxDQUFDLFNBQVMsR0FBRyxZQUFZLENBQUM7ZUFDL0IsTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDekIsbUJBQUcsQ0FBQyxJQUFJLDBCQUF3QixJQUFJLENBQUMsU0FBUyxjQUFTLElBQUksQ0FBQyxTQUFTLENBQUcsQ0FBQztBQUN6RSxvQkFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO2VBQ2pDO2FBQ0Y7QUFDRCxlQUFHLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDOzs7Ozs7O0tBQzVEOzs7U0F6TUcsT0FBTzs7O3FCQTRNRSxPQUFPIiwiZmlsZSI6ImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCB7IGdldFN1bW1hcnlCeUNvZGUgfSBmcm9tICcuLi9qc29ud3Atc3RhdHVzL3N0YXR1cyc7XG5pbXBvcnQgeyBlcnJvcnMsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSB9IGZyb20gJy4uL3Byb3RvY29sL2Vycm9ycyc7XG5cblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignSlNPTldQIFByb3h5Jyk7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuY29uc3QgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQgPSAyNDAwMDA7XG5cbmNsYXNzIEpXUHJveHkge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCB7XG4gICAgICBzY2hlbWU6ICdodHRwJyxcbiAgICAgIHNlcnZlcjogJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiA0NDQ0LFxuICAgICAgYmFzZTogJy93ZC9odWInLFxuICAgICAgc2Vzc2lvbklkOiBudWxsLFxuICAgICAgdGltZW91dDogREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQsXG4gICAgfSwgb3B0cyk7XG4gICAgdGhpcy5zY2hlbWUgPSB0aGlzLnNjaGVtZS50b0xvd2VyQ2FzZSgpO1xuICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gIH1cblxuICAvLyBhYnN0cmFjdCB0aGUgY2FsbCBiZWhpbmQgYSBtZW1iZXIgZnVuY3Rpb25cbiAgLy8gc28gdGhhdCB3ZSBjYW4gbW9jayBpdCBpbiB0ZXN0c1xuICBhc3luYyByZXF1ZXN0ICguLi5hcmdzKSB7XG4gICAgY29uc3QgY3VycmVudFJlcXVlc3QgPSByZXF1ZXN0KC4uLmFyZ3MpO1xuICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLnB1c2goY3VycmVudFJlcXVlc3QpO1xuICAgIHJldHVybiBhd2FpdCBjdXJyZW50UmVxdWVzdC5maW5hbGx5KCgpID0+IF8ucHVsbCh0aGlzLl9hY3RpdmVSZXF1ZXN0cywgY3VycmVudFJlcXVlc3QpKTtcbiAgfVxuXG4gIGdldEFjdGl2ZVJlcXVlc3RzQ291bnQgKCkge1xuICAgIHJldHVybiB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5sZW5ndGg7XG4gIH1cblxuICBjYW5jZWxBY3RpdmVSZXF1ZXN0cyAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGZvciAobGV0IHIgb2YgdGhpcy5fYWN0aXZlUmVxdWVzdHMpIHtcbiAgICAgICAgci5jYW5jZWwoKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICB9XG4gIH1cblxuICBlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIChlbmRwb2ludCkge1xuICAgIHJldHVybiAhXy5pbmNsdWRlcyhbJy9zZXNzaW9uJywgJy9zZXNzaW9ucycsICcvc3RhdHVzJ10sIGVuZHBvaW50KTtcbiAgfVxuXG4gIGdldFVybEZvclByb3h5ICh1cmwpIHtcbiAgICBpZiAodXJsID09PSAnJykge1xuICAgICAgdXJsID0gJy8nO1xuICAgIH1cbiAgICBjb25zdCBwcm94eUJhc2UgPSBgJHt0aGlzLnNjaGVtZX06Ly8ke3RoaXMuc2VydmVyfToke3RoaXMucG9ydH0ke3RoaXMuYmFzZX1gO1xuICAgIGNvbnN0IGVuZHBvaW50UmUgPSAnKC8oc2Vzc2lvbnxzdGF0dXMpKSc7XG4gICAgbGV0IHJlbWFpbmluZ1VybCA9ICcnO1xuICAgIGlmICgvXmh0dHAvLnRlc3QodXJsKSkge1xuICAgICAgY29uc3QgZmlyc3QgPSAobmV3IFJlZ0V4cChgKGh0dHBzPzovLy4rKSR7ZW5kcG9pbnRSZX1gKSkuZXhlYyh1cmwpO1xuICAgICAgaWYgKCFmaXJzdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBhIGNvbXBsZXRlIHVybCBidXQgY291bGQgbm90IGV4dHJhY3QgSldQIGVuZHBvaW50Jyk7XG4gICAgICB9XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmwucmVwbGFjZShmaXJzdFsxXSwgJycpO1xuICAgIH0gZWxzZSBpZiAoKG5ldyBSZWdFeHAoJ14vJykpLnRlc3QodXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gdXJsO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggdXJsICcke3VybH0nYCk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyaXBQcmVmaXhSZSA9IG5ldyBSZWdFeHAoJ14uKygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG4gICAgcmV0dXJuIHByb3h5QmFzZSArIHJlbWFpbmluZ1VybDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5ICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBtZXRob2QgPSBtZXRob2QudG9VcHBlckNhc2UoKTtcbiAgICBjb25zdCBuZXdVcmwgPSB0aGlzLmdldFVybEZvclByb3h5KHVybCk7XG4gICAgY29uc3QgcmVxT3B0cyA9IHtcbiAgICAgIHVybDogbmV3VXJsLFxuICAgICAgbWV0aG9kLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnLFxuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICcqLyonLFxuICAgICAgfSxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgZm9yZXZlcjogdHJ1ZSxcbiAgICB9O1xuICAgIGlmIChib2R5ICE9PSBudWxsKSB7XG4gICAgICBpZiAodHlwZW9mIGJvZHkgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgfVxuICAgICAgcmVxT3B0cy5qc29uID0gYm9keTtcbiAgICB9XG5cbiAgICAvLyBHRVQgbWV0aG9kcyBzaG91bGRuJ3QgaGF2ZSBhbnkgYm9keS4gTW9zdCBzZXJ2ZXJzIGFyZSBPSyB3aXRoIHRoaXMsIGJ1dCBXZWJEcml2ZXJBZ2VudCB0aHJvd3MgNDAwIGVycm9yc1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICByZXFPcHRzLmpzb24gPSBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGJvZHlMb2cgPSBib2R5ID8gYHdpdGggYm9keTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGJvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWAgOiAnd2l0aCBubyBib2R5JztcbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgXCIvXCJ9XSB0byBbJHttZXRob2R9ICR7bmV3VXJsfV0gJHtib2R5TG9nfWApO1xuXG4gICAgbGV0IHJlcywgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5yZXF1ZXN0KHJlcU9wdHMpO1xuICAgICAgcmVzQm9keSA9IHJlcy5ib2R5O1xuICAgICAgbG9nLmRlYnVnKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogTE9HX09CSl9MRU5HVEh9KX1gKTtcbiAgICAgIGlmICgvXFwvc2Vzc2lvbiQvLnRlc3QodXJsKSAmJiBtZXRob2QgPT09ICdQT1NUJykge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gcmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMykge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gL1xcL3Nlc3Npb25cXC8oW15cXC9dKykvLmV4ZWMocmVzQm9keSlbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsZXQgcmVzcG9uc2VFcnJvcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc3BvbnNlRXJyb3IgPSBKU09OLnBhcnNlKGUuZXJyb3IpO1xuICAgICAgfSBjYXRjaCAoZTEpIHtcbiAgICAgICAgaWYgKF8uaXNTdHJpbmcoZS5lcnJvcikgJiYgZS5lcnJvci5sZW5ndGgpIHtcbiAgICAgICAgICBsb2cud2FybihgR290IHVuZXhwZWN0ZWQgcmVzcG9uc2U6ICR7Xy50cnVuY2F0ZShlLmVycm9yLCB7bGVuZ3RoOiAzMDB9KX1gKTtcbiAgICAgICAgfVxuICAgICAgICByZXNwb25zZUVycm9yID0gXy5pc1BsYWluT2JqZWN0KGUuZXJyb3IpID8gZS5lcnJvciA6IG51bGw7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKGBDb3VsZCBub3QgcHJveHkgY29tbWFuZCB0byByZW1vdGUgc2VydmVyLiBgICArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gLCByZXNwb25zZUVycm9yLCBlLnN0YXR1c0NvZGUpO1xuICAgIH1cbiAgICByZXR1cm4gW3JlcywgcmVzQm9keV07XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIHJlc0JvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzQm9keSk7XG4gICAgaWYgKHV0aWwuaGFzVmFsdWUocmVzQm9keS5zdGF0dXMpKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gTUpTT05XUCBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzQm9keS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0dXMgPSBwYXJzZUludChyZXNCb2R5LnN0YXR1cywgMTApO1xuICAgICAgaWYgKCFpc05hTihzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHJlc0JvZHkudmFsdWU7XG4gICAgICAgIGlmIChfLmhhcyhyZXNCb2R5LnZhbHVlLCAnbWVzc2FnZScpKSB7XG4gICAgICAgICAgbWVzc2FnZSA9IF8uaXNFbXB0eShtZXNzYWdlKSA/IHJlc0JvZHkudmFsdWUubWVzc2FnZSA6IGAke21lc3NhZ2V9ICR7cmVzQm9keS52YWx1ZS5tZXNzYWdlfWA7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUoc3RhdHVzLCBfLmlzRW1wdHkobWVzc2FnZSkgPyBnZXRTdW1tYXJ5QnlDb2RlKHN0YXR1cykgOiBtZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKF8uaGFzKHJlc0JvZHksICd2YWx1ZScpKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gVzNDIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QocmVzQm9keS52YWx1ZSkgJiYgcmVzQm9keS52YWx1ZS5lcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvckZyb21XM0NKc29uQ29kZShyZXNCb2R5LnZhbHVlLmVycm9yLCByZXNCb2R5LnZhbHVlLm1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAvLyBVbmtub3duIHByb3RvY29sLiBLZWVwaW5nIGl0IGJlY2F1c2Ugb2YgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgIHJldHVybiByZXNCb2R5O1xuICAgIH1cbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICcke3Jlc3BvbnNlLnN0YXR1c0NvZGV9JyBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgYW5kIHJlc3BvbnNlIGJvZHkgJyR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShyZXNCb2R5KSwge2xlbmd0aDogMzAwfSl9J2ApO1xuICB9XG5cbiAgZ2V0U2Vzc2lvbklkRnJvbVVybCAodXJsKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB1cmwubWF0Y2goL1xcL3Nlc3Npb25cXC8oW15cXC9dKykvKTtcbiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcVJlcyAocmVxLCByZXMpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCBib2R5XSA9IGF3YWl0IHRoaXMucHJveHkocmVxLm9yaWdpbmFsVXJsLCByZXEubWV0aG9kLCByZXEuYm9keSk7XG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBib2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChib2R5ICYmIGJvZHkuc2Vzc2lvbklkKSB7XG4gICAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICAgIGlmIChyZXFTZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3JlcVNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSByZXFTZXNzaW9uSWQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7Ym9keS5zZXNzaW9uSWR9IHdpdGggJHt0aGlzLnNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25JZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
